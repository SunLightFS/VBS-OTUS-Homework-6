# Занятие №7: Журналы

1. Настройте выполнение контрольной точки раз в 30 секунд.  
**Выполнение:** Установил параметр *checkpoint_timeout* в значение *30s*
2. 10 минут c помощью утилиты pgbench подавайте нагрузку.  
**Выполнение:** */usr/pgsql-13/bin/pgbench -c8 -P 10 -T 600 -U postgres postgres*
3. Измерьте, какой объем журнальных файлов был сгенерирован за это время.  
**Выполнение:** Сначала у меня тут ничего не вышло, т.к. старые wal затирались и их суммарный объем не поднимался выше 64МБ. Поднял в конфиге значения параметров min_wal_size и wal_keep_size до 2GB, а max_wal_size - до 5 GB.
До запуска pbench размер каталога pg_wal был равен 80МБ, после выполнения - 481M.
4. Оцените, какой объем приходится в среднем на одну контрольную точку.  
**Выполнение:** За время работы pgbench было сделано 20 контрольных точек, таким образом на одну контрольную точку приходится 20МБ
5. Проверьте данные статистики: все ли контрольные точки выполнялись точно по расписанию. Почему так произошло?  
**Выполнение:** Судя по результатам запроса *SELECT * FROM pg_stat_bgwriter \gx* все контрольные точки выполнялись вовремя - значение параметра checkpoints_timed равно 131, а параметр checkpoints_req - 0, т.к. вручную выполнение контрольной точки не запрашивалось, а для автоматического запуска вне расписания размер wal не достаточно высок по сравнению с max_wal_size (по умолчанию значение этого параметра 1GB, так что даже без изменений этого параметра, внесенных на шаге 3, ничего не изменилось бы).
6. Сравните tps в синхронном/асинхронном режиме утилитой pgbench. Объясните полученный результат.  
**Выполнение:** Средний tps в синхронном режиме равен 893, в асинхронном - 1984, т.е. при переходе на асинхронный режим tps вырос более чем в 2 раза. Причина заключается в том, что при работе в синхронном режиме при завершении каждой транзакции происходит запись необходимой информации в WAL. При асинхронном же режиме фиксация транзакции может происходить до её записи на диск, что увеличивает быстродействие, но сопровождается риском в случае сбоя потерять данные о части транзакций, которые не успели записаться на диск.
7. Создайте новый кластер с включенной контрольной суммой страниц. Создайте таблицу. Вставьте несколько значений. Выключите кластер. Измените пару байт в таблице. Включите кластер и сделайте выборку из таблицы. Что и почему произошло? как проигнорировать ошибку и продолжить работу?  
**Выполнение:**  
        - Включение контрольной суммы (не включал при инициализации БД): */usr/pgsql-13/bin/pg_checksums -D /var/lib/pgsql/13/data -e -P -v*  
        - Создание таблицы и вставка значений: *CREATE TABLE T_TEST (t1 int); INSERT INTO T_TEST VALUES (1), (2), (3), (4);*  
        - После остановки кластера, изменения зачения в файле таблицы и запуска кластера, при селекте из таблицы выдается ошибка, т.к. не сошлась контрольная сумма
        - Проигнорировать ошибку можно установив параметр *ignore_checksum_failure* в значение *on*: *set ignore_checksum_failure=on;*
        - После этого селект из таблицы проходит, хотя доступны не все данные (у меня первые две строки вывелись пустые, остальные нормальные).
